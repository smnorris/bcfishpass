#!/bin/bash
set -euxo pipefail

# For each WCRP, rank barriers and dump to file
PSQL="psql $DATABASE_URL -v ON_ERROR_STOP=1"
WCRPS=$($PSQL -AXt -c "SELECT DISTINCT wcrp FROM bcfishpass.wcrp_watersheds WHERE wcrp is not null")
for wcrp in $WCRPS
do
  python jobs/auto_rank.py $wcrp

  # Note that proprietary discharge is used for select watershed groups, exclude it from dumps
  # (mad_m3s will be null for BULK/HORS/ELKR)
  ogr2ogr \
    -f GPKG \
    streams_$wcrp.gpkg.zip \
    PG:$DATABASE_URL \
    --debug ON \
    -nln streams \
    -sql "SELECT
    s.segmented_stream_id,
    s.linear_feature_id,
    s.edge_type,
    s.blue_line_key,
    s.watershed_key,
    s.watershed_group_code,
    s.downstream_route_measure,
    s.length_metre,
    s.waterbody_key,
    s.wscode::text as wscode,
    s.localcode::text as localcode,
    s.gnis_name,
    s.stream_order,
    s.stream_magnitude,
    s.gradient,
    s.feature_code,
    s.upstream_route_measure,
    s.upstream_area_ha,
    s.stream_order_parent,
    s.stream_order_max,
    s.map_upstream,
    s.channel_width,
    CASE
      WHEN s.watershed_group_code IN ('BULK','ELKR', 'HORS') THEN NULL
      ELSE s.mad_m3s
    END as mad_m3s,
    s.barriers_anthropogenic_dnstr,
    s.barriers_pscis_dnstr,
    s.barriers_dams_dnstr,
    s.barriers_dams_hydro_dnstr,
    s.barriers_ch_cm_co_pk_sk_dnstr,
    s.barriers_ct_dv_rb_dnstr,
    s.barriers_st_dnstr,
    s.barriers_wct_dnstr,
    s.crossings_dnstr,
    s.dam_dnstr_ind,
    s.dam_hydro_dnstr_ind,
    s.remediated_dnstr_ind,
    s.obsrvtn_event_upstr,
    s.obsrvtn_species_codes_upstr,
    s.species_codes_dnstr,
    s.access_ch,
    s.access_cm,
    s.access_co,
    s.access_pk,
    s.access_sk,
    s.access_st,
    s.access_wct,
    s.access_salmon,
    s.spawning_ch,
    s.spawning_cm,
    s.spawning_co,
    s.spawning_pk,
    s.spawning_sk,
    s.spawning_st,
    s.spawning_wct,
    s.rearing_ch,
    s.rearing_co,
    s.rearing_sk,
    s.rearing_st,
    s.rearing_wct,
    s.geom
  FROM bcfishpass.streams_vw s
  INNER JOIN bcfishpass.wcrp_watersheds w
  ON s.watershed_group_code = w.watershed_group_code
  WHERE w.wcrp = '$wcrp'"

  # add crossings_wcrp_vw

done



# Dump *provincial* crossings, streams, and assessment watershed level reporting
# to .gpkg/csv on BC object storage - for general use and as per PSF spec
# As above, mad_m3s is null for BULK/HORS/ELKR

ogr2ogr \
  -f GPKG \
  bcfishpass_crossings.gpkg.zip \
  PG:$DATABASE_URL \
  --debug ON \
  -nln crossings \
  -sql "SELECT
  aggregated_crossings_id,
  stream_crossing_id,
  dam_id,
  user_barrier_anthropogenic_id,
  modelled_crossing_id,
  crossing_source,
  crossing_feature_type,
  pscis_status,
  crossing_type_code,
  crossing_subtype_code,
  modelled_crossing_type_source,
  barrier_status,
  pscis_road_name,
  pscis_stream_name,
  pscis_assessment_comment,
  pscis_assessment_date,
  pscis_final_score,
  transport_line_structured_name_1,
  transport_line_type_description,
  transport_line_surface_description,
  ften_forest_file_id,
  ften_road_section_id,
  ften_file_type_description,
  ften_client_number,
  ften_client_name,
  ften_life_cycle_status_code,
  ften_map_label,
  rail_track_name,
  rail_owner_name,
  rail_operator_english_name,
  ogc_proponent,
  dam_name,
  dam_height,
  dam_owner,
  dam_use,
  dam_operating_status,
  utm_zone,
  utm_easting,
  utm_northing,
  dbm_mof_50k_grid,
  linear_feature_id,
  blue_line_key,
  watershed_key,
  downstream_route_measure,
  wscode::text as wscode,
  localcode::text as localcode,
  watershed_group_code,
  gnis_stream_name,
  stream_order,
  stream_magnitude,
  upstream_area_ha,
  stream_order_parent,
  stream_order_max,
  map_upstream,
  channel_width,
  CASE
     WHEN watershed_group_code IN ('BULK','ELKR', 'HORS') THEN NULL
     ELSE mad_m3s
  END as mad_m3s,
  observedspp_dnstr,
  observedspp_upstr,
  crossings_dnstr,
  barriers_anthropogenic_dnstr,
  barriers_anthropogenic_dnstr_count,
  barriers_anthropogenic_upstr,
  barriers_anthropogenic_upstr_count,
  barriers_anthropogenic_bt_upstr,
  barriers_anthropogenic_upstr_bt_count,
  barriers_anthropogenic_ch_cm_co_pk_sk_upstr,
  barriers_anthropogenic_ch_cm_co_pk_sk_upstr_count,
  barriers_anthropogenic_st_upstr,
  barriers_anthropogenic_st_upstr_count,
  barriers_anthropogenic_wct_upstr,
  barriers_anthropogenic_wct_upstr_count,
  gradient,
  total_network_km,
  total_stream_km,
  total_lakereservoir_ha,
  total_wetland_ha,
  total_slopeclass03_waterbodies_km,
  total_slopeclass03_km,
  total_slopeclass05_km,
  total_slopeclass08_km,
  total_slopeclass15_km,
  total_slopeclass22_km,
  total_slopeclass30_km,
  total_belowupstrbarriers_network_km,
  total_belowupstrbarriers_stream_km,
  total_belowupstrbarriers_lakereservoir_ha,
  total_belowupstrbarriers_wetland_ha,
  total_belowupstrbarriers_slopeclass03_waterbodies_km,
  total_belowupstrbarriers_slopeclass03_km,
  total_belowupstrbarriers_slopeclass05_km,
  total_belowupstrbarriers_slopeclass08_km,
  total_belowupstrbarriers_slopeclass15_km,
  total_belowupstrbarriers_slopeclass22_km,
  total_belowupstrbarriers_slopeclass30_km,
  barriers_bt_dnstr,
  bt_network_km,
  bt_stream_km,
  bt_lakereservoir_ha,
  bt_wetland_ha,
  bt_slopeclass03_waterbodies_km,
  bt_slopeclass03_km,
  bt_slopeclass05_km,
  bt_slopeclass08_km,
  bt_slopeclass15_km,
  bt_slopeclass22_km,
  bt_slopeclass30_km,
  bt_belowupstrbarriers_network_km,
  bt_belowupstrbarriers_stream_km,
  bt_belowupstrbarriers_lakereservoir_ha,
  bt_belowupstrbarriers_wetland_ha,
  bt_belowupstrbarriers_slopeclass03_waterbodies_km,
  bt_belowupstrbarriers_slopeclass03_km,
  bt_belowupstrbarriers_slopeclass05_km,
  bt_belowupstrbarriers_slopeclass08_km,
  bt_belowupstrbarriers_slopeclass15_km,
  bt_belowupstrbarriers_slopeclass22_km,
  bt_belowupstrbarriers_slopeclass30_km,
  barriers_ch_cm_co_pk_sk_dnstr,
  ch_cm_co_pk_sk_network_km,
  ch_cm_co_pk_sk_stream_km,
  ch_cm_co_pk_sk_lakereservoir_ha,
  ch_cm_co_pk_sk_wetland_ha,
  ch_cm_co_pk_sk_slopeclass03_waterbodies_km,
  ch_cm_co_pk_sk_slopeclass03_km,
  ch_cm_co_pk_sk_slopeclass05_km,
  ch_cm_co_pk_sk_slopeclass08_km,
  ch_cm_co_pk_sk_slopeclass15_km,
  ch_cm_co_pk_sk_slopeclass22_km,
  ch_cm_co_pk_sk_slopeclass30_km,
  ch_cm_co_pk_sk_belowupstrbarriers_network_km,
  ch_cm_co_pk_sk_belowupstrbarriers_stream_km,
  ch_cm_co_pk_sk_belowupstrbarriers_lakereservoir_ha,
  ch_cm_co_pk_sk_belowupstrbarriers_wetland_ha,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass03_waterbodies_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass03_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass05_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass08_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass15_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass22_km,
  ch_cm_co_pk_sk_belowupstrbarriers_slopeclass30_km,
  barriers_st_dnstr,
  st_network_km,
  st_stream_km,
  st_lakereservoir_ha,
  st_wetland_ha,
  st_slopeclass03_waterbodies_km,
  st_slopeclass03_km,
  st_slopeclass05_km,
  st_slopeclass08_km,
  st_slopeclass15_km,
  st_slopeclass22_km,
  st_slopeclass30_km,
  st_belowupstrbarriers_network_km,
  st_belowupstrbarriers_stream_km,
  st_belowupstrbarriers_lakereservoir_ha,
  st_belowupstrbarriers_wetland_ha,
  st_belowupstrbarriers_slopeclass03_waterbodies_km,
  st_belowupstrbarriers_slopeclass03_km,
  st_belowupstrbarriers_slopeclass05_km,
  st_belowupstrbarriers_slopeclass08_km,
  st_belowupstrbarriers_slopeclass15_km,
  st_belowupstrbarriers_slopeclass22_km,
  st_belowupstrbarriers_slopeclass30_km,
  barriers_wct_dnstr,
  wct_network_km,
  wct_stream_km,
  wct_lakereservoir_ha,
  wct_wetland_ha,
  wct_slopeclass03_waterbodies_km,
  wct_slopeclass03_km,
  wct_slopeclass05_km,
  wct_slopeclass08_km,
  wct_slopeclass15_km,
  wct_slopeclass22_km,
  wct_slopeclass30_km,
  wct_belowupstrbarriers_network_km,
  wct_belowupstrbarriers_stream_km,
  wct_belowupstrbarriers_lakereservoir_ha,
  wct_belowupstrbarriers_wetland_ha,
  wct_belowupstrbarriers_slopeclass03_waterbodies_km,
  wct_belowupstrbarriers_slopeclass03_km,
  wct_belowupstrbarriers_slopeclass05_km,
  wct_belowupstrbarriers_slopeclass08_km,
  wct_belowupstrbarriers_slopeclass15_km,
  wct_belowupstrbarriers_slopeclass22_km,
  wct_belowupstrbarriers_slopeclass30_km,
  bt_spawning_km,
  bt_rearing_km,
  bt_spawning_belowupstrbarriers_km,
  bt_rearing_belowupstrbarriers_km,
  ch_spawning_km,
  ch_rearing_km,
  ch_spawning_belowupstrbarriers_km,
  ch_rearing_belowupstrbarriers_km,
  cm_spawning_km,
  cm_spawning_belowupstrbarriers_km,
  co_spawning_km,
  co_rearing_km,
  co_rearing_ha,
  co_spawning_belowupstrbarriers_km,
  co_rearing_belowupstrbarriers_km,
  co_rearing_belowupstrbarriers_ha,
  pk_spawning_km,
  pk_spawning_belowupstrbarriers_km,
  sk_spawning_km,
  sk_rearing_km,
  sk_rearing_ha,
  sk_spawning_belowupstrbarriers_km,
  sk_rearing_belowupstrbarriers_km,
  sk_rearing_belowupstrbarriers_ha,
  st_spawning_km,
  st_rearing_km,
  st_spawning_belowupstrbarriers_km,
  st_rearing_belowupstrbarriers_km,
  wct_spawning_km,
  wct_rearing_km,
  wct_spawning_belowupstrbarriers_km,
  wct_rearing_belowupstrbarriers_km,
  geom
FROM bcfishpass.crossings_vw"

ogr2ogr \
  -f GPKG \
  bcfishpass_streams.gpkg.zip \
  PG:$DATABASE_URL \
  --debug ON \
  -nln streams \
  -sql "SELECT
  segmented_stream_id,
  linear_feature_id,
  edge_type,
  blue_line_key,
  watershed_key,
  watershed_group_code,
  downstream_route_measure,
  length_metre,
  waterbody_key,
  wscode::text as wscode,
  localcode::text as localcode,
  gnis_name,
  stream_order,
  stream_magnitude,
  gradient,
  feature_code,
  upstream_route_measure,
  upstream_area_ha,
  stream_order_parent,
  stream_order_max,
  map_upstream,
  channel_width,
  CASE
    WHEN watershed_group_code IN ('BULK','ELKR', 'HORS') THEN NULL
    ELSE mad_m3s
  END as mad_m3s,
  barriers_anthropogenic_dnstr,
  barriers_pscis_dnstr,
  barriers_dams_dnstr,
  barriers_dams_hydro_dnstr,
  barriers_bt_dnstr,
  barriers_ch_cm_co_pk_sk_dnstr,
  barriers_ct_dv_rb_dnstr,
  barriers_st_dnstr,
  barriers_wct_dnstr,
  crossings_dnstr,
  dam_dnstr_ind,
  dam_hydro_dnstr_ind,
  remediated_dnstr_ind,
  obsrvtn_event_upstr,
  obsrvtn_species_codes_upstr,
  species_codes_dnstr,
  access_bt,
  access_ch,
  access_cm,
  access_co,
  access_pk,
  access_sk,
  access_st,
  access_wct,
  access_salmon,
  spawning_bt,
  spawning_ch,
  spawning_cm,
  spawning_co,
  spawning_pk,
  spawning_sk,
  spawning_st,
  spawning_wct,
  rearing_bt,
  rearing_ch,
  rearing_co,
  rearing_sk,
  rearing_st,
  rearing_wct,
  mapping_code_bt,
  mapping_code_ch,
  mapping_code_cm,
  mapping_code_co,
  mapping_code_pk,
  mapping_code_sk,
  mapping_code_st,
  mapping_code_wct,
  mapping_code_salmon,
  geom
FROM bcfishpass.streams_vw"

psql $DATABASE_URL -c "select
  assessment_watershed_id,
  length_potentiallyaccessible_obsrvd_salmon,
  length_potentiallyaccessible_obsrvd_salmon_access_b,
  length_potentiallyaccessible_model_salmon,
  length_potentiallyaccessible_model_salmon_access_b,
  length_potentiallyaccessible_obsrvd_st,
  length_potentiallyaccessible_obsrvd_st_access_b,
  length_potentiallyaccessible_model_st,
  length_potentiallyaccessible_model_st_access_b,
  length_spawningrearing_obsrvd_ch,
  length_spawningrearing_obsrvd_ch_access_b,
  length_spawningrearing_model_ch,
  length_spawningrearing_model_ch_access_b,
  length_spawningrearing_obsrvd_cm,
  length_spawningrearing_obsrvd_cm_access_b,
  length_spawningrearing_model_cm,
  length_spawningrearing_model_cm_access_b,
  length_spawningrearing_obsrvd_co,
  length_spawningrearing_obsrvd_co_access_b,
  length_spawningrearing_model_co,
  length_spawningrearing_model_co_access_b,
  length_spawningrearing_obsrvd_pk,
  length_spawningrearing_obsrvd_pk_access_b,
  length_spawningrearing_model_pk,
  length_spawningrearing_model_pk_access_b,
  length_spawningrearing_obsrvd_sk,
  length_spawningrearing_obsrvd_sk_access_b,
  length_spawningrearing_model_sk,
  length_spawningrearing_model_sk_access_b,
  length_spawningrearing_obsrvd_st,
  length_spawningrearing_obsrvd_st_access_b,
  length_spawningrearing_model_st,
  length_spawningrearing_model_st_access_b,
  length_spawningrearing_obsrvd_salmon,
  length_spawningrearing_obsrvd_salmon_access_b,
  length_spawningrearing_model_salmon,
  length_spawningrearing_model_salmon_access_b,
  length_spawningrearing_obsrvd_salmon_st,
  length_spawningrearing_obsrvd_salmon_st_access_b,
  length_spawningrearing_model_salmon_st,
  length_spawningrearing_model_salmon_st_access_b,
  pct_potentiallyaccessible_salmon_access_b,
  pct_potentiallyaccessible_st_access_b,
  pct_spawningrearing_ch_access_b,
  pct_spawningrearing_cm_access_b,
  pct_spawningrearing_co_access_b,
  pct_spawningrearing_pk_access_b,
  pct_spawningrearing_sk_access_b,
  pct_spawningrearing_st_access_b,
  pct_spawningrearing_salmon_access_b,
  pct_spawningrearing_salmon_st_access_b
from bcfishpass.aw_linear_summary_current a" --csv > bcfishpass_summary_aw_linear.csv

# upload/make public
aws s3 cp bcfishpass_crossings.gpkg.zip s3://bchamp --acl public-read
aws s3 cp bcfishpass_streams.gpkg.zip s3://bchamp --acl public-read
aws s3 cp bcfishpass_summary_aw_linear.csv s3://bchamp --acl public-read