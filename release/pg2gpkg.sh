#!/bin/bash
set -euxo pipefail


echo "dumping bcfishpass data from "$DATABASE_URL


# streams
ogr2ogr \
    -f GPKG \
    bcfishpass.gpkg \
    -nln streams \
    PG:$DATABASE_URL \
    -sql "select
     segmented_stream_id,
     linear_feature_id,
     edge_type,
     blue_line_key,
     watershed_key,
     watershed_group_code,
     downstream_route_measure,
     length_metre,
     waterbody_key,
     wscode_ltree,
     localcode_ltree,
     gnis_name,
     stream_order,
     stream_magnitude,
     gradient,
     feature_code,
     upstream_route_measure,
     upstream_area_ha,
     stream_order_parent,
     stream_order_max,
     map_upstream,
     channel_width,
     mad_m3s,
     array_to_string(barriers_anthropogenic_dnstr, ';') as barriers_anthropogenic_dnstr,
     array_to_string(barriers_pscis_dnstr, ';') as barriers_pscis_dnstr,
     array_to_string(barriers_dams_dnstr, ';') as barriers_dams_dnstr,
     array_to_string(barriers_dams_hydro_dnstr, ';') as barriers_dams_hydro_dnstr,
     array_to_string(barriers_bt_dnstr, ';') as barriers_bt_dnstr,
     array_to_string(barriers_ch_cm_co_pk_sk_dnstr, ';') as barriers_ch_cm_co_pk_sk_dnstr,
     array_to_string(barriers_ct_dv_rb_dnstr, ';') as barriers_ct_dv_rb_dnstr,
     array_to_string(barriers_st_dnstr, ';') as barriers_st_dnstr,
     array_to_string(barriers_wct_dnstr, ';') as barriers_wct_dnstr,
     array_to_string(crossings_dnstr, ';') as crossings_dnstr,
     remediated_dnstr,
     array_to_string(obsrvtn_event_upstr, ';') as obsrvtn_event_upstr,
     array_to_string(obsrvtn_species_codes_upstr, ';') as obsrvtn_species_codes_upstr,
     array_to_string(species_codes_dnstr, ';') as species_codes_dnstr,
     model_spawning_bt,
     model_spawning_ch,
     model_spawning_cm,
     model_spawning_co,
     model_spawning_pk,
     model_spawning_sk,
     model_spawning_st,
     model_spawning_wct,
     model_rearing_bt,
     model_rearing_ch,
     model_rearing_co,
     model_rearing_sk,
     model_rearing_st,
     model_rearing_wct,
     mapping_code_bt,
     mapping_code_ch,
     mapping_code_cm,
     mapping_code_co,
     mapping_code_pk,
     mapping_code_sk,
     mapping_code_st,
     mapping_code_wct,
     mapping_code_salmon,
     geom
   from bcfishpass.streams"


# crossings
# this is a duplicate of what is available via the provincial data, but contains additional attributes
ogr2ogr \
    -f GPKG \
    bcfishpass.gpkg \
    -update \
    -nln crossings \
    PG:$DATABASE_URL \
    -sql "select
    aggregated_crossings_id,
     stream_crossing_id,
     dam_id,
     user_barrier_anthropogenic_id,
     modelled_crossing_id,
     crossing_source,
     crossing_feature_type,
     pscis_status,
     crossing_type_code,
     crossing_subtype_code,
     modelled_crossing_type_source,
     barrier_status,
     pscis_road_name,
     pscis_stream_name,
     pscis_assessment_comment,
     pscis_assessment_date,
     pscis_final_score,
     transport_line_structured_name_1,
     transport_line_type_description,
     transport_line_surface_description,
     ften_forest_file_id,
     ften_file_type_description,
     ften_client_number,
     ften_client_name,
     ften_life_cycle_status_code,
     rail_track_name,
     rail_owner_name,
     rail_operator_english_name,
     ogc_proponent,
     dam_name,
     dam_height,
     dam_owner,
     dam_use,
     dam_operating_status,
     utm_zone,
     utm_easting,
     utm_northing,
     dbm_mof_50k_grid,
     linear_feature_id,
     blue_line_key,
     watershed_key,
     downstream_route_measure,
     wscode_ltree,
     localcode_ltree,
     watershed_group_code,
     gnis_stream_name,
     stream_order,
     stream_magnitude,
     array_to_string(observedspp_dnstr, ';') as observedspp_dnstr,
     array_to_string(observedspp_upstr, ';') as observedspp_upstr,
     array_to_string(crossings_dnstr, ';') as crossings_dnstr,
     array_to_string(barriers_anthropogenic_dnstr, ';') as barriers_anthropogenic_dnstr,
     array_to_string(barriers_anthropogenic_upstr, ';') as barriers_anthropogenic_upstr,
     gradient,
     total_network_km,
     total_stream_km,
     total_lakereservoir_ha,
     total_wetland_ha,
     total_slopeclass03_waterbodies_km,
     total_slopeclass03_km,
     total_slopeclass05_km,
     total_slopeclass08_km,
     total_slopeclass15_km,
     total_slopeclass22_km,
     total_slopeclass30_km,
     total_belowupstrbarriers_network_km,
     total_belowupstrbarriers_stream_km,
     total_belowupstrbarriers_lakereservoir_ha,
     total_belowupstrbarriers_wetland_ha,
     total_belowupstrbarriers_slopeclass03_waterbodies_km,
     total_belowupstrbarriers_slopeclass03_km,
     total_belowupstrbarriers_slopeclass05_km,
     total_belowupstrbarriers_slopeclass08_km,
     total_belowupstrbarriers_slopeclass15_km,
     total_belowupstrbarriers_slopeclass22_km,
     total_belowupstrbarriers_slopeclass30_km,
     array_to_string(barriers_bt_dnstr, ';') as barriers_bt_dnstr,
     bt_network_km,
     bt_stream_km,
     bt_lakereservoir_ha,
     bt_wetland_ha,
     bt_slopeclass03_waterbodies_km,
     bt_slopeclass03_km,
     bt_slopeclass05_km,
     bt_slopeclass08_km,
     bt_slopeclass15_km,
     bt_slopeclass22_km,
     bt_slopeclass30_km,
     bt_belowupstrbarriers_network_km,
     bt_belowupstrbarriers_stream_km,
     bt_belowupstrbarriers_lakereservoir_ha,
     bt_belowupstrbarriers_wetland_ha,
     bt_belowupstrbarriers_slopeclass03_waterbodies_km,
     bt_belowupstrbarriers_slopeclass03_km,
     bt_belowupstrbarriers_slopeclass05_km,
     bt_belowupstrbarriers_slopeclass08_km,
     bt_belowupstrbarriers_slopeclass15_km,
     bt_belowupstrbarriers_slopeclass22_km,
     bt_belowupstrbarriers_slopeclass30_km,
     array_to_string(barriers_ch_cm_co_pk_sk_dnstr, ';') as barriers_ch_cm_co_pk_sk_dnstr,
     ch_cm_co_pk_sk_network_km,
     ch_cm_co_pk_sk_stream_km,
     ch_cm_co_pk_sk_lakereservoir_ha,
     ch_cm_co_pk_sk_wetland_ha,
     ch_cm_co_pk_sk_slopeclass03_waterbodies_km,
     ch_cm_co_pk_sk_slopeclass03_km,
     ch_cm_co_pk_sk_slopeclass05_km,
     ch_cm_co_pk_sk_slopeclass08_km,
     ch_cm_co_pk_sk_slopeclass15_km,
     ch_cm_co_pk_sk_slopeclass22_km,
     ch_cm_co_pk_sk_slopeclass30_km,
     ch_cm_co_pk_sk_belowupstrbarriers_network_km,
     ch_cm_co_pk_sk_belowupstrbarriers_stream_km,
     ch_cm_co_pk_sk_belowupstrbarriers_lakereservoir_ha,
     ch_cm_co_pk_sk_belowupstrbarriers_wetland_ha,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass03_waterbodies_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass03_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass05_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass08_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass15_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass22_km,
     ch_cm_co_pk_sk_belowupstrbarriers_slopeclass30_km,
     array_to_string(barriers_st_dnstr, ';') as barriers_st_dnstr,
     st_network_km,
     st_stream_km,
     st_lakereservoir_ha,
     st_wetland_ha,
     st_slopeclass03_waterbodies_km,
     st_slopeclass03_km,
     st_slopeclass05_km,
     st_slopeclass08_km,
     st_slopeclass15_km,
     st_slopeclass22_km,
     st_slopeclass30_km,
     st_belowupstrbarriers_network_km,
     st_belowupstrbarriers_stream_km,
     st_belowupstrbarriers_lakereservoir_ha,
     st_belowupstrbarriers_wetland_ha,
     st_belowupstrbarriers_slopeclass03_waterbodies_km,
     st_belowupstrbarriers_slopeclass03_km,
     st_belowupstrbarriers_slopeclass05_km,
     st_belowupstrbarriers_slopeclass08_km,
     st_belowupstrbarriers_slopeclass15_km,
     st_belowupstrbarriers_slopeclass22_km,
     st_belowupstrbarriers_slopeclass30_km,
     barriers_wct_dnstr,
     wct_network_km,
     wct_stream_km,
     wct_lakereservoir_ha,
     wct_wetland_ha,
     wct_slopeclass03_waterbodies_km,
     wct_slopeclass03_km,
     wct_slopeclass05_km,
     wct_slopeclass08_km,
     wct_slopeclass15_km,
     wct_slopeclass22_km,
     wct_slopeclass30_km,
     wct_belowupstrbarriers_network_km,
     wct_belowupstrbarriers_stream_km,
     wct_belowupstrbarriers_lakereservoir_ha,
     wct_belowupstrbarriers_wetland_ha,
     wct_belowupstrbarriers_slopeclass03_waterbodies_km,
     wct_belowupstrbarriers_slopeclass03_km,
     wct_belowupstrbarriers_slopeclass05_km,
     wct_belowupstrbarriers_slopeclass08_km,
     wct_belowupstrbarriers_slopeclass15_km,
     wct_belowupstrbarriers_slopeclass22_km,
     wct_belowupstrbarriers_slopeclass30_km,
     bt_spawning_km,
     bt_rearing_km,
     bt_spawning_belowupstrbarriers_km,
     bt_rearing_belowupstrbarriers_km,
     ch_spawning_km,
     ch_rearing_km,
     ch_spawning_belowupstrbarriers_km,
     ch_rearing_belowupstrbarriers_km,
     cm_spawning_km,
     cm_spawning_belowupstrbarriers_km,
     co_spawning_km,
     co_rearing_km,
     co_rearing_ha,
     co_spawning_belowupstrbarriers_km,
     co_rearing_belowupstrbarriers_km,
     co_rearing_belowupstrbarriers_ha,
     pk_spawning_km,
     pk_spawning_belowupstrbarriers_km,
     sk_spawning_km,
     sk_rearing_km,
     sk_rearing_ha,
     sk_spawning_belowupstrbarriers_km,
     sk_rearing_belowupstrbarriers_km,
     sk_rearing_belowupstrbarriers_ha,
     st_spawning_km,
     st_rearing_km,
     st_spawning_belowupstrbarriers_km,
     st_rearing_belowupstrbarriers_km,
     wct_spawning_km,
     wct_rearing_km,
     wct_spawning_belowupstrbarriers_km,
     wct_rearing_belowupstrbarriers_km,
     all_spawning_km,
     all_spawning_belowupstrbarriers_km,
     all_rearing_km,
     all_rearing_belowupstrbarriers_km,
     all_spawningrearing_km,
     all_spawningrearing_belowupstrbarriers_km,
     wct_betweenbarriers_network_km,
     wct_spawning_betweenbarriers_km,
     wct_rearing_betweenbarriers_km,
     wct_spawningrearing_betweenbarriers_km,
     all_spawningrearing_per_barrier,
     barriers_anthropogenic_dnstr_count,
     barriers_anthropogenic_upstr_count,
     from bcfishpass.crossings"

7z a bcfishpass.gpkg.zip bcfishpass.gpkg
aws s3 cp bcfishpass.gpkg.zip s3://bcfishpass/
aws s3api put-object-acl --bucket bcfishpass --key bcfishpass.gpkg.zip --acl public-read


# dump column descriptions
psql2csv "SELECT a.attname As column_name,  d.description
FROM pg_class As c
INNER JOIN pg_attribute As a ON c.oid = a.attrelid
LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace
LEFT JOIN pg_description As d ON (d.objoid = c.oid AND d.objsubid = a.attnum)
WHERE  c.relkind IN('r', 'v') AND  n.nspname = 'bcfishpass' AND c.relname = 'crossings'
AND a.attname not in ('cmax','cmin','tableoid','xmax','xmin','ctid','geom');" > bcfishpass_crossings_column_descriptions.csv

psql2csv "SELECT a.attname As column_name,  d.description
FROM pg_class As c
INNER JOIN pg_attribute As a ON c.oid = a.attrelid
LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace
LEFT JOIN pg_description As d ON (d.objoid = c.oid AND d.objsubid = a.attnum)
WHERE  c.relkind IN('r', 'v') AND  n.nspname = 'bcfishpass' AND c.relname = 'streams'
AND a.attname not in ('cmax','cmin','tableoid','xmax','xmin','ctid','geom');" > bcfishpass_streams_column_descriptions.csv

#zip -Dr bcfishpass.gpkg.zip bcfishpass.gpkg
#rm bcfishpass.gpkg