#!/bin/bash
set -euxo pipefail

#-------
# weekly data refresh
#-------

PSQL="psql $DATABASE_URL -v ON_ERROR_STOP=1"


# bcdata loads
jq -c '.[]' bcgw_sources.json | while read item; do
    schedule=$(jq -r '.schedule' <<< "$item")
    source=$(jq -r '.source' <<< "$item")
    if [ "$schedule" == "W" ] ; then
      echo "Loading $source from cache"

      # this can fail without an exit 1, capture stderr
      output=$(ogr2ogr -f PostgreSQL \
        "PG:$DATABASE_URL" \
        --config OGR_TRUNCATE=YES \
        -append \
        -preserve_fid \
        -nln $source \
        --config PG_USE_COPY=YES \
        /vsicurl/https://nrs.objectstore.gov.bc.ca/bchamp/bcdata/$source.parquet \
        $source 2>&1)
        
        if [[ "$output" == *"ERROR"* ]]; then
          echo "Error detected in command output: $output"
          exit 1
        fi

      # after successful ogr2ogr load (only reached if no ERROR in output)
      object_key="bcdata/${source}.parquet"
      metadata=$(aws s3api head-object \
        --bucket bchamp \
        --key "$object_key" \
        --endpoint-url https://nrs.objectstore.gov.bc.ca \
        --output json 2>&1)

      version_id=$(echo "$metadata" | jq -r '.VersionId // "null"')
      etag=$(echo "$metadata" | jq -r '.ETag | gsub("\""; "")')  # strip surrounding quotes

      $PSQL -c "INSERT INTO bcfishpass.log_replication (object_name, version_id, etag, replication_timestamp)
        VALUES ('${source}', ${version_id}, '${etag}', NOW())
        ON CONFLICT (object_name)
        DO UPDATE SET version_id = EXCLUDED.version_id, etag = EXCLUDED.etag, replication_timestamp = NOW();"

    fi
done

# cabd
ogr2ogr -f PostgreSQL \
  "PG:$DATABASE_URL" \
  -append \
  --config OGR_TRUNCATE=YES \
  --config PG_USE_COPY=YES \
  -nln cabd.dams \
  "https://cabd-web.azurewebsites.net/cabd-api/features/dams?filter=province_territory_code:eq:bc&filter=use_analysis:eq:true" \
  OGRGeoJSON

ogr2ogr -f PostgreSQL \
  "PG:$DATABASE_URL" \
  -append \
  --config OGR_TRUNCATE=YES \
  --config PG_USE_COPY=YES \
  -nln cabd.waterfalls \
  "https://cabd-web.azurewebsites.net/cabd-api/features/waterfalls?filter=province_territory_code:eq:bc&filter=use_analysis:eq:true" \
  OGRGeoJSON
